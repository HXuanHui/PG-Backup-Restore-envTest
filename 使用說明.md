# PostgreSQL 備份還原測試 - 快速使用指南

## 前置需求

### 遠端伺服器需求
- PostgreSQL 16
- pgbackrest 已安裝並配置
- pgbench 工具
- sudo 權限
- PostgreSQL 服務名稱: `postgresql@16-test`
- pgbackrest stanza 名稱: `test-backup`
- PostgreSQL 監聽埠: `5433`

### 本地端需求

**Python 版本：**
- Python 3.6+
- paramiko 套件

**Shell 版本：**
- bash
- ssh 客戶端
- 遠端伺服器需安裝 `bc` 命令

## 快速開始

### 方法一：Python 版本（推薦，Windows 可用）

1. **安裝依賴**
```bash
pip install -r requirements.txt
```

2. **執行腳本**
```bash
python pg_backup_restore_test.py
```

3. **依提示輸入連線資訊**
   - 主機名稱或 IP
   - 使用者名稱
   - 選擇認證方式（密碼或金鑰檔案）
   - 輸入對應的認證資訊

### 方法二：Shell 版本（Linux/Mac）

1. **賦予執行權限**
```bash
chmod +x pg_backup_restore_test.sh
```

2. **執行腳本**
```bash
# 使用密碼認證
./pg_backup_restore_test.sh 192.168.1.100 admin

# 使用 SSH 金鑰認證
./pg_backup_restore_test.sh 192.168.1.100 admin ~/.ssh/id_rsa
```

## 測試流程說明

腳本會自動執行以下測試項目：
- 1GB (scale factor: 10)
- 3GB (scale factor: 30)
- 5GB (scale factor: 50)
- 9GB (scale factor: 90)

每個測試項目包含：
1. 使用 pgbench 初始化測試資料
2. 查詢並記錄資料庫實際大小
3. 執行 pgbackrest 完整備份（記錄時間和 CPU）
4. 停止 PostgreSQL 服務
5. 刪除資料目錄（模擬災難恢復）
6. 執行 pgbackrest 還原（記錄時間和 CPU）
7. 重新啟動 PostgreSQL 服務

## 輸出結果

腳本會生成兩個報告檔案：

1. **test_results_YYYYMMDD_HHMMSS.json**
   - 完整的測試結果（JSON 格式）
   - 包含所有時間和 CPU 數據

2. **test_results_YYYYMMDD_HHMMSS.txt** (Python 版本)
   - 易讀的文字報告
   - 包含測試總結表格

## 注意事項

1. **測試時間**：完整測試可能需要數小時，請確保有足夠時間
2. **網路連線**：確保 SSH 連線穩定
3. **磁碟空間**：確保遠端伺服器有足夠空間存放測試資料和備份
4. **權限**：確保 SSH 使用者有執行 sudo 的權限
5. **服務狀態**：測試過程中會停止和啟動 PostgreSQL，請確保沒有其他重要服務依賴

## 疑難排解

### SSH 連線失敗
- 檢查主機名稱或 IP 是否正確
- 確認 SSH 服務正在運行
- 檢查防火牆設定
- 確認認證資訊正確

### 權限錯誤
- 確認 SSH 使用者有 sudo 權限
- 檢查 sudoers 設定

### PostgreSQL 服務無法啟動
- 檢查 PostgreSQL 日誌
- 確認資料目錄權限正確
- 檢查 pgbackrest 配置

### CPU 監控數據不準確
- 確認遠端伺服器有 `vmstat` 或 `top` 命令
- 檢查 `/tmp` 目錄的寫入權限

## 自訂設定

如需修改測試的資料大小，編輯腳本中的測試配置：

**Python 版本：**
```python
test_configs = [
    (10, "1GB"),
    (30, "3GB"),
    (50, "5GB"),
    (90, "9GB")
]
```

**Shell 版本：**
```bash
declare -a TEST_CONFIGS=(
    "10:1GB"
    "30:3GB"
    "50:5GB"
    "90:9GB"
)
```

pgbench scale factor 約略對應（根據實際測試結果，每個 scale factor ≈ 15 MB）：
- `-s 68` ≈ 1GB (1024 MB)
- `-s 205` ≈ 3GB (3072 MB)
- `-s 341` ≈ 5GB (5120 MB)
- `-s 614` ≈ 9GB (9216 MB)

實際大小可能因資料內容而略有差異。
